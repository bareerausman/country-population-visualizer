<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Country Population Visualizer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .flag-img {
            width: 40px;
            height: 30px;
            object-fit: cover;
            border: 1px solid #ddd;
            border-radius: 3px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .population-cell {
            text-align: right;
            font-family: monospace;
            font-size: 0.9rem;
        }
        .table th {
            background-color: #f8f9fa;
            position: sticky;
            top: 0;
            z-index: 1;
        }
        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: none;
            z-index: 1000;
            background: rgba(255,255,255,0.8);
            padding: 20px;
            border-radius: 10px;
        }
        .chart-container {
            height: 400px;
            margin-bottom: 20px;
        }
        .table-container {
            max-height: 600px;
            overflow-y: auto;
        }
        .country-name {
            font-weight: 500;
        }
        .card {
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
<div class="container mt-5">
    <h1 class="mb-4">Country Population Visualizer</h1>

    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Population Distribution</h5>
                    <div class="chart-container">
                        <canvas id="populationChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Country Details</h5>
                    <div class="table-container">
                        <table class="table table-striped table-hover">
                            <thead>
                            <tr>
                                <th>Flag</th>
                                <th>Country</th>
                                <th>Capital</th>
                                <th>Population</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr th:each="country : ${countries}">
                                <td>
                                    <img th:src="${country.flag != null ? country.flag : 'https://via.placeholder.com/40x30?text=No+Flag'}"
                                         th:alt="${country.name + ' flag'}"
                                         class="flag-img"
                                         onerror="this.onerror=null; this.src='https://via.placeholder.com/40x30?text=No+Flag';">
                                </td>
                                <td class="country-name" th:text="${country.name}"></td>
                                <td th:text="${country.capital != null ? country.capital : 'N/A'}"></td>
                                <td class="population-cell" th:text="${country.formattedPopulation}"></td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="loading">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
</div>

<script th:inline="javascript">
    const countries = [[${countries}]];

    // Sort countries by population (handling null values)
    const sortedCountries = [...countries]
        .filter(country => country.population != null && country.population > 0)
        .sort((a, b) => b.population - a.population);
    const top20Countries = sortedCountries.slice(0, 20);

    const ctx = document.getElementById('populationChart').getContext('2d');
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: top20Countries.map(c => c.name),
            datasets: [{
                label: 'Population',
                data: top20Countries.map(c => c.population),
                backgroundColor: 'rgba(54, 162, 235, 0.7)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 1,
                borderRadius: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                title: {
                    display: true,
                    text: 'Top 20 Countries by Population',
                    font: {
                        size: 16,
                        weight: 'bold'
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return 'Population: ' + context.raw.toLocaleString();
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return Number(value).toLocaleString();
                        }
                    },
                    title: {
                        display: true,
                        text: 'Population'
                    }
                },
                x: {
                    ticks: {
                        maxRotation: 45,
                        minRotation: 45
                    }
                }
            }
        }
    });
</script>
</body>
</html>