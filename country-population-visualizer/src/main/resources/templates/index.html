<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Country Population Visualizer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .flag-img {
            width: 40px;
            height: 30px;
            object-fit: cover;
            border: 1px solid #ddd;
            border-radius: 3px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .population-cell {
            text-align: right;
            font-family: monospace;
            font-size: 0.9rem;
        }
        .table th {
            background-color: #f8f9fa;
            position: sticky;
            top: 0;
            z-index: 1;
        }
        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: none;
            z-index: 1000;
            background: rgba(255,255,255,0.8);
            padding: 20px;
            border-radius: 10px;
        }
        .chart-container {
            height: 400px;
            margin-bottom: 20px;
        }
        .table-container {
            max-height: 600px;
            overflow-y: auto;
        }
        .country-name {
            font-weight: 500;
        }
        .card {
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
<div class="container mt-5">
    <h1 class="mb-4 text-center">Country Population Visualizer</h1>

    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Population Distribution</h5>
                    <div class="chart-container">
                        <canvas id="populationChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Country Details</h5>
                    <div class="table-container">
                        <table class="table table-striped table-hover">
                            <thead>
                            <tr>
                                <th>Flag</th>
                                <th>Country</th>
                                <th>Capital</th>
                                <th>Population</th>
                            </tr>
                            </thead>
                            <tbody id="countryTableBody">
                            <!-- Rows dynamically inserted here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="loading" id="loadingSpinner">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', async () => {
        const API_URL = 'https://restcountries.com/v3.1/all'; // API endpoint
        const tableBody = document.getElementById('countryTableBody');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const ctx = document.getElementById('populationChart').getContext('2d');

        loadingSpinner.style.display = 'block'; // Show loading spinner

        try {
            const response = await fetch(API_URL);
            if (!response.ok) throw new Error('Failed to fetch data');
            const countries = await response.json();

            // Process and sort countries by population
            const sortedCountries = countries
                .filter(country => country.population)
                .sort((a, b) => b.population - a.population);

            // Populate the table
            sortedCountries.forEach(country => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <img src="${country.flags?.png || 'https://via.placeholder.com/40x30?text=No+Flag'}"
                             alt="${country.name?.common} flag"
                             class="flag-img"
                             onerror="this.src='https://via.placeholder.com/40x30?text=No+Flag';">
                    </td>
                    <td class="country-name">${country.name?.common || 'N/A'}</td>
                    <td>${country.capital?.[0] || 'N/A'}</td>
                    <td class="population-cell">${country.population.toLocaleString()}</td>
                `;
                tableBody.appendChild(row);
            });

            // Top 20 countries for chart
            const top20 = sortedCountries.slice(0, 20);
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: top20.map(c => c.name.common),
                    datasets: [{
                        label: 'Population',
                        data: top20.map(c => c.population),
                        backgroundColor: 'rgba(54, 162, 235, 0.7)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        title: {
                            display: true,
                            text: 'Top 20 Countries by Population',
                            font: { size: 16, weight: 'bold' }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return Number(value).toLocaleString();
                                }
                            },
                            title: {
                                display: true,
                                text: 'Population'
                            }
                        },
                        x: {
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45
                            }
                        }
                    }
                }
            });

        } catch (error) {
            console.error('Error:', error);
        } finally {
            loadingSpinner.style.display = 'none'; // Hide loading spinner
        }
    });
</script>
</body>
</html>